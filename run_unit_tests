#!/bin/sh
. /usr/local/lib/test_lib.sh

if [ "$1" = "" ]; then
    branch="master"
else
    branch=$1
fi

checkout_branch "$branch"
prep_branch 
try cd "$TEST_DIR/$PROJECT"

mybranch=$(thisbranch)

if [ "$mybranch" != "$branch" ]; then
    echo "want to run $0 on $branch but $mybranch is checked out"
    echo "set_test_env '$branch' must be run prior to this job"
    exit 1
fi


try cd "$TEST_DIR"
if ! test -f "$VIRTUAL_ENV"/bin/activate; then
    prep_venv
    . "$VIRTUAL_ENV"/bin/activate
fi
branch_dir=${TEST_DIR}/output/$(echo "$branch"| sed -e 's/\//_/g')
mkdir -p  "$branch_dir/xml_reports"
/bin/bash  ./glideinwms/build/jenkins/run_unittests.sh -ac 2>&1 | tee "$branch_dir"/unit_test.log
mv ./glideinwms/unittests/unittests-reports/* "$branch_dir/xml_reports"
mv ./htmlcov* "$branch_dir"
mv ./coverage.report.* "$branch_dir"
mv ./*.out "$branch_dir"
mv ./*.log "$branch_dir"
